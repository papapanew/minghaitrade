{include file="public/layout" /}

<body class="bodystyle" style="overflow-x: hidden;padding: 0;min-width: 674px;background: #fff;">
<style type="text/css">
    .ncap-form-default dd.opt { width: 79%; }
    .select-express {border: 1px solid red !important; color: red !important;}
</style>
<div id="append_parent"></div>
<div id="ajaxwaitid"></div>
<div class="page" style="width: 810px;margin: 0 auto;">
    <div class="flexigrid">
        <form class="form-horizontal" id="postForm">
            <input type="hidden" name="users_id" value="{$OrderData.users_id}">
            <input type="hidden" name="order_id" value="{$OrderData.order_id}">
            <input type="hidden" name="order_code" value="{$OrderData.order_code}">
            <input type="hidden" name="order_status" value="{$OrderData.order_status}">
            <input type="hidden" name="refund_code" value="{$refund_code}">
            <div class="ncap-form-default">
                <dl class="row">
                    <dt class="tit">
                        <label>商品总额</label>
                    </dt>
                    <dd class="opt">
                        {empty name="$OrderData.points_shop_order"}￥{/empty}{$OrderData.totalAmount}
                    </dd>
                </dl>

                <dl class="row">
                    <dt class="tit">
                        <label>商品实付款</label>
                    </dt>
                    <dd class="opt">
                        {empty name="$OrderData.points_shop_order"}￥{/empty}{$OrderData.order_amount}
                    </dd>
                </dl>

                {notempty name="$OrderData.points_shop_order"}
                <dl class="row">
                    <dt class="tit">
                        <label>实际退回积分</label>
                    </dt>
                    <dd class="opt">
                       <input type="text" value="" data-points="" name="" id="" class="input-txt" onpaste='this.value=this.value.replace(/[^\d]/g, "");' onkeyup='this.value=this.value.replace(/[^\d]/g, ""); actualPoints(this);'>
                    </dd>
                </dl>
                {/notempty}

                <dl class="row">
                    <dt class="tit">
                        <label>实际退回余额</label>
                    </dt>
                    <dd class="opt">
                       <input type="text" value="{$OrderData.order_amount}" data-price="{$OrderData.order_amount}" name="actual_price" id="actual_price" class="input-txt" onpaste='this.value=this.value.replace(/[^\d.]/g, "");' onkeyup='this.value=this.value.replace(/[^\d.]/g, ""); actualAmount(this);'>
                    </dd>
                </dl>

                <dl class="row">
                    <dt class="tit"> <label>退款方式</label> </dt>
                    <dd class="opt" style="line-height: 30px;">
                        <label>
                            <input type="radio" name="refund_way" id="refund_way" value="1">退款到余额{notempty name="$OrderData.points_shop_order"}(积分){/notempty}
                        </label>
                        &nbsp;&nbsp;&nbsp;
                        <label>
                            <input type="radio" name="refund_way" id="refund_way" value="2">线下退款
                        </label>
                        &nbsp;&nbsp;&nbsp;
                        <label title="用户使用微信支付下单才可以选择">
                            <input type="radio" name="refund_way" id="refund_way" value="3" {if condition="'wechat' != $OrderData.pay_name || empty($usersConfig.pay_original_refund)"} disabled="true" {/if}>原路退回(微信)
                        </label>
                    </dd>
                </dl>

                <dl class="row">
                    <dt class="tit">
                        <label>退款说明</label>
                    </dt>
                    <dd class="opt">
                        <textarea rows="5" cols="60" name="refund_note" style="height: 80px;"></textarea>
                    </dd>
                </dl>
            </div>

            <div class="ncap-form-default">
                <div class="bot" style="padding-bottom: 0px;">
                    <a href="JavaScript:void(0);" onclick="submitServiceRefund();" class="ncap-btn-big ncap-btn-green">确认退款</a>
                    <a href="JavaScript:void(0);" onclick="closeIframes();" style="height: 20px; padding: 7px 19px;">取消</a>
                </div>
            </div>
        </form>
    </div>
</div>

<script type="text/javascript">
    // 关闭自身弹窗
    function closeIframes(isAjax) {
        var parentObj = parent.layer.getFrameIndex(window.name);
        if (parentObj) {
            if (isAjax) {
                parent.window.location.reload();
            } else {
                parent.layer.close(parentObj);
            }
        }
    }

    // 验证实际退款金额是否超过
    function actualAmount(obj) {
        var value = $(obj).val();
        var price = $(obj).data('price');
        if (parseFloat(value) > parseFloat(price)) {
            $(obj).val(price);
        } else {
            $(obj).val(value);
        }
    }

    // 验证实际退款积分是否超过
    function actualPoints(obj) {
        var value = $(obj).val();
        var price = $(obj).data('points');
        if (parseInt(value) > parseInt(price)) {
            $(obj).val(price);
        } else {
            $(obj).val(value);
        }
    }

    // 表单提交
    function submitServiceRefund() {
        if (!$('#refund_way:checked').val()) {
            showErrorMsg('请选择退款方式');
            return false;
        }
        var actualAmount = $('#actual_price').val();
        if (isNaN(actualAmount) || 0 > parseFloat(actualAmount)) {
            showErrorMsg('实际退款余额不能小于0');
            $('#actual_price').focus();
            return false;
        }
        layer_loading('正在处理');
        $.ajax({
            type: "post",
            url : "{:url('Shop/order_manual_refund', ['_ajax'=>1])}",
            data: $('#postForm').serialize(),
            dataType: 'json',
            success: function (res) {
                layer.closeAll();
                if (res.code == 1) {
                    layer.msg(res.msg, {time: 1000}, function() {
                        closeIframes(true);
                    });
                } else {
                    layer.alert(res.msg, {icon: 2, title: false, closeBtn: 0});
                }
            },
            error:function(e){
                layer.closeAll();
                layer.alert(e.responseText, {icon: 2, title: false, closeBtn: 0});
            }
        });
    }
</script> 
