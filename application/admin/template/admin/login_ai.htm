<!DOCTYPE html>
<meta name="renderer" content="webkit">
<meta http-equiv="X-UA-Compatible" content="IE=Edge,chrome=1" >
<html>
    <head>
        <meta charset="utf-8">
        <meta http-equiv="Content-Language" content="zh-cn"/>
        <meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport" />
        <meta name='robots' content='noindex,nofollow' />
        <title>后台登录</title>
        <link rel="shortcut icon" type="image/x-icon" href="__ROOT_DIR__/favicon.ico?v={$version}" media="screen"/>
        <link href="__SKIN__/css/login_ai.css?v={$version}" rel="stylesheet" type="text/css" />
        <link href="__SKIN__/font/css/iconfont.css?v={$version}" rel="stylesheet" type="text/css" />
        {load href="__STATIC__/common/js/jquery.min.js" /}
        <script type="text/javascript" src="__SKIN__/js/jquery.validation.min.js"></script>
        <script type="text/javascript" src="__SKIN__/js/jquery.cookie.js"></script>
        <script type="text/javascript" src="__PUBLIC__/plugins/layer-v3.1.0/layer.js"></script>
        <!--[if lte IE 8]>
            <script type="Text/Javascript" language="JavaScript">
                function detectBrowser()
                {
                    var browser = navigator.appName
                    if(navigator.userAgent.indexOf("MSIE")>0){ 
                        var b_version = navigator.appVersion
                        var version = b_version.split(";");
                        var trim_Version = version[1].replace(/[ ]/g,"");
                        if ((browser=="Netscape"||browser=="Microsoft Internet Explorer"))
                        {
                            if(trim_Version == 'MSIE8.0' || trim_Version == 'MSIE7.0' || trim_Version == 'MSIE6.0'){
                                layer.alert('请使用IE9.0版本以上进行访问', {icon: 5, title:false});
                                return false;
                            }
                        }
                    }
               }
               detectBrowser();
            </script>
        <![endif]-->
        <script type="text/javascript">
            var eyou_basefile = "{$Request.baseFile}";
            var layer_shade = [0.7, '#fafafa'];
        </script>
    </head>

    <body>
        <div id="container">
            <div id="anitOut"></div>
        </div>
        <div class="container">
            <div class="login-left">
                <video autoplay muted loop id="background-video" preload="none" poster="__SKIN__/login/poster.webp">
                    <source src="__SKIN__/login/login_ai.mp4" type="video/mp4">
                    您的浏览器不支持视频标签
                </video>
                <div class="login-info">
                    <h1>EYOUCMS</h1>
                    <p>AI+ 探索未知</p>
                </div>
            </div>
            <div class="login-right">
                <div class="login-switch">
                    <i class="iconfont e-pc1 switch-input" id="pcLogin" style="display: none;"></i>
                    <i class="iconfont e-co swicth-ercode" id="qrcodeLogin" {if condition="$login_type != 3"}style="display:none;"{/if}></i>
                </div>
                <div class="login-form-container">
                    <div class="logo">
                        <img src="{$global.web_loginlogo|handle_subdir_pic=###|default='__SKIN__/images/login-logo_ai.png'}?v={$time}" class="logo">
                    </div>
                     <form action="" name='theForm' id="theForm" method="post" class="login-form SignBox" {if condition="$login_type == 3"}style="display:none;"{/if} onsubmit="return false;">
                        <div class="form-group">
                            <span class="icon"><i class="iconfont e-yonghu"></i></span>
                            <input type="text" id="username" name="user_name" autocomplete="off" class="form-control" value="" placeholder="用户名" required autofocus />
                        </div>
                        <div class="form-group">
                            <span class="icon"><i class="iconfont e-mima"></i></span>
                            <input type="password" name="password" id="password" autocomplete="off" class="form-control" value="" placeholder="密码" required />
                            <span class="password-toggle hide pass-showhide" data-name="password" id="passwordToggle">
                                <i class="iconfont e-yincang"></i>
                            </span>
                        </div>
                        {eq name="$is_vertify" value="1"}
                        <div class="form-group captcha-group">
                            <span class="icon"><i class="iconfont e-yanzhengma"></i></span>
                            <input type="text" id="captcha" name="vertify" autocomplete="off" class="form-control" value="" placeholder="验证码" />
                            <div class="captcha-image">
                                <img src="__STATIC__/common/images/loading.gif?v={$version}" class="chicuele loading_vertify" id="imgVerify">
                                <span id="refreshCaptcha" onclick="fleshVerify();"><i class="iconfont e-shuaxin"></i></span>
                            </div>
                        </div>
                        {/eq}

                        <!--点选文字验证码 start-->
                        <!-- weapp_clicap_input -->
                        <!--点选文字验证码 end-->
                        
                        <button type="button" name="submit" id="loginButton" class="login-btn">登录</button>
                    </form>
                    {if condition="in_array($third_login, ['EyouGzhLogin','userGzhLogin'])"}
                    <div id="qrcodeContainer" class="qrcode-login ercodeSignBox" {if condition="$login_type != 3"}style="display:none;"{/if}>
                        <div class="qrcode-container">
                            <div class="ercodepic" style="height: 200px;"><img src="__STATIC__/common/images/loading.gif?v={$version}" id="qrcodeImage" style="width: 23px; height: 23px;margin-top: 50px;"></div>
                            <div class="qrcode-tip">
                                <p class="qrcode-status">打开微信扫一扫</p>
                            </div>
                        </div>
                    </div>
                    {elseif condition="$third_login == 'WechatLogin'" /}
                    <div style="padding: 35px 30px 30px 30px;"></div>
                    {/if}
                    
                </div>
            </div>
        </div>
        <div id="message" class="message"></div>
        <script type="text/javascript">
            document.addEventListener('DOMContentLoaded', function() {
                // 获取DOM元素
                const theForm = document.getElementById('theForm');
                const qrcodeContainer = document.getElementById('qrcodeContainer');
                const passwordInput = document.getElementById('password');
                const passwordToggle = document.getElementById('passwordToggle');
                const loginButton = document.getElementById('loginButton');
                const messageBox = document.getElementById('message');
                const pcLoginIcon = document.getElementById('pcLogin');
                const qrcodeLoginIcon = document.getElementById('qrcodeLogin');

                // 登录方式切换
                pcLoginIcon.addEventListener('click', function() {
                    this.style.display = 'none';
                    qrcodeLoginIcon.style.display = 'block';
                    theForm.style.display = 'block';
                    qrcodeContainer.style.display = 'none';
                    // 这里可以添加获取二维码的逻辑
                    // refreshQrcode();
                });

                qrcodeLoginIcon.addEventListener('click', function() {
                    this.style.display = 'none';
                    pcLoginIcon.style.display = 'block';
                    theForm.style.display = 'none';
                    qrcodeContainer.style.display = 'block';
                });

                // 二维码状态轮询
                function checkQrcodeStatus() {
                    if (qrcodeContainer.style.display !== 'none') {
                        // 这里添加检查二维码状态的逻辑
                        // 可以使用setInterval定期检查
                    }
                }

                // 密码显示/隐藏切换
                passwordToggle.addEventListener('click', function() {
                    const type = passwordInput.getAttribute('type');
                    if (type === 'password') {
                        passwordInput.setAttribute('type', 'text');
                        passwordToggle.innerHTML = '<i class="iconfont e-zhengkai"></i>';
                    } else {
                        passwordInput.setAttribute('type', 'password');
                        passwordToggle.innerHTML = '<i class="iconfont e-yincang"></i>';
                    }
                });
                
            }); 
        </script>
        <script type="text/javascript">
            var third_login = "{$third_login|default=''}";
            var notifyPolling = null;
            var qrcodePolling = null;
            $(function () {
                var login_type = {$login_type|default='1'};
                if (3 == login_type) {
                    if (0 <= $.inArray(third_login, ['EyouGzhLogin','userGzhLogin'])) {
                        getQrCode();
                        qrcodePolling = setInterval(function(){getQrCode();}, 5*60*1000);
                    }
                    else if ('WechatLogin' == third_login) {
                        var url = "{:url('Admin/wechat_login', [], true, true)}";
                        var iframes = layer.open({
                            type: 2,
                            title: '打开微信扫一扫',
                            fixed: false, //固定
                            shadeClose: false,
                            resize: false,
                            move: false,
                            shade: layer_shade,
                            offset: '200px',
                            closeBtn: false,
                            area: ['500px', '460px'],
                            content: url
                        });
                    }
                }
            })

            $(".swicth-ercode").click(function (e) {
                e.preventDefault();
                if (0 <= $.inArray(third_login, ['EyouGzhLogin','userGzhLogin'])) {
                    $(".SignBox").hide();
                    $(".ercodeSignBox").show();
                    getQrCode();
                    qrcodePolling = setInterval(function(){getQrCode();}, 5*60*1000);
                } else {
                    var url = "{:url('Admin/wechat_login', [], true, true)}";
                    var iframes = layer.open({
                        type: 2,
                        title: '打开微信扫一扫',
                        fixed: true, //不固定
                        shadeClose: false,
                        shade: layer_shade,
                        offset: '200px',
                        // maxmin: true, //开启最大化最小化按钮
                        area: ['500px', '460px'],
                        content: url
                    });
                }
            });
            $(".switch-input").click(function (e) {
                e.preventDefault();
                $(".SignBox").show();
                $(".ercodeSignBox").hide();
                clearNotify();
                clearQrcode();
                $('.ercodepic').html('<img src="__STATIC__/common/images/loading.gif?v={$version}" style="width: 23px; height: 23px;margin-top: 50px;">');
            });
            
            function fleshVerify(){
                var src = "{:url('Admin/vertify')}";
                if (src.indexOf('?') > -1) {
                    src += '&';
                } else {
                    src += '?';
                }
                src += 't='+Math.floor(Math.random()*10000000);
                $('#imgVerify').attr('src', src);//重载验证码
            }

            function getQrCode(){
                $.ajax({
                    type: 'POST',
                    url: '{:url("Admin/mp_getqrcode")}',
                    data: {op:'login', _ajax:1},
                    dataType: "JSON",
                    success: function(res){
                        if (1 == res.code){
                            $('.ercodepic').html("<img src='https://mp.weixin.qq.com/cgi-bin/showqrcode?ticket="+res.data.ticket+"'>");
                            getNotify(res.data.uniqid_scene);
                        }else{
                            clearQrcode();
                            layer.alert(res.msg, {icon: 5, title:false}, function(){
                                window.location.reload();
                            });
                        }
                    },
                    error: function(e){
                        clearQrcode();
                        layer.alert(e.responseText, {icon: 5, title:false}, function(){
                            window.location.reload();
                        });
                    }
                });
            }

            function getNotify(uniqid_scene){
                notifyPolling = setTimeout(function(){
                    $.ajax({
                        type: 'POST',
                        url: "{:url('Admin/mp_bingwxgzhopenid')}",
                        data: {op:'login', uniqid_scene:uniqid_scene, _ajax:1},
                        dataType: "JSON",
                        success: function(res){
                            if (1 == res.data.code) {
                                clearNotify();
                                layer_loading('准备进入');
                                window.location.href = res.url;
                            } else if (0 == res.code) {
                                clearNotify();
                                layer.alert(res.msg, {icon: 5, title:false, closeBtn:false}, function(){
                                    window.location.reload();
                                });
                            } else if (2 == res.data.code) {
                                getNotify(uniqid_scene);
                            }
                        },
                        error: function(e){
                            clearNotify();
                            layer.alert('扫码检测异常，重新尝试！', {icon: 5, title:false, closeBtn:false}, function(){
                                window.location.reload();
                            });
                        }
                    });
                }, 1800);
            }

            function clearNotify(){
                if(notifyPolling > 0){
                    clearTimeout(notifyPolling);
                    notifyPolling = null;
                }
            }

            function clearQrcode(){
                if(qrcodePolling > 0){
                    clearInterval(qrcodePolling);
                    qrcodePolling = null;
                }
            }

            /**
             * 封装的加载层
             */
            function layer_loading(msg){
                var loading = layer.msg(
                msg+'...&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;请勿刷新页面', 
                {
                    icon: 1,
                    time: 3600000, //1小时后后自动关闭
                    shade: [0.2] //0.1透明度的白色背景
                });
                //loading层
                var index = layer.load(3, {
                    shade: [0.1,'#fff'] //0.1透明度的白色背景
                });

                return loading;
            }
            
            $(function(){
                
                setTimeout(function(){
                    $('.loading_vertify').removeClass('loading_vertify').attr('src', '');
                    fleshVerify();
                },800);

                $(".formText .input-text").focus(function(){
                    $(this).parent().addClass("focus");
                });
                
                $(".formText .input-text").blur(function(){
                    $(this).parent().removeClass("focus");
                });
                
                $(".formText").blur(function(){
                    $(this).prev().hide();
                });

                $(document).keydown(function(event){
                    if(event.keyCode ==13){
                        $('#theForm #loginButton').trigger("click");
                    }
                });

                /**
                 * 明文密码
                 */
                $(".pass-showhide").attr('data-showOrHide', 'hide');
                $(".pass-showhide").on('click', function(){
                    var showOrHide = $(this).attr('data-showOrHide');
                    if ('hide' == showOrHide) {
                        $(this).attr('data-showOrHide', 'show');
                        var name = $(this).data('name');
                        $("input[name="+name+"]").get(0).type="text";
                        $(this).removeClass('hide').addClass('show');
                    } else {
                        $(this).attr('data-showOrHide', 'hide');
                        var name = $(this).data('name');
                        $("input[name="+name+"]").get(0).type="password";
                        $(this).removeClass('show').addClass('hide');
                    }
                });
                $('#theForm #loginButton').on('click',function(){
                    var user_name=true;
                    var password=true;
                    var vertify=true;
                    var _this = this;

                    if($('#theForm input[name=user_name]').val() == ''){
                        layer.msg('用户名不能为空！', {time: 1000});
                        $('#theForm input[name=user_name]').focus();
                        user_name = false;
                        return false;
                    }

                    if($('#theForm input[name=password]').val() == ''){
                        layer.msg('密码不能为空！', {time: 1000});
                        $('#theForm input[name=password]').focus();
                        password = false;
                        return false;
                    }

                    var is_vertify = {$is_vertify|default=1};
                    if (1 == is_vertify) {
                        if($('#theForm input[name=vertify]').val() == ''){
                            layer.msg('验证码不能为空！', {time: 1000});
                            $('#theForm input[name=vertify]').focus();
                            vertify = false;
                            return false;
                        }
                    }

                    if(vertify && $('#theForm input[name=user_name]').val() != '' && $('#theForm input[name=password]').val() != ''){
                        var url = "{:url('Admin/login', ['_ajax'=>1])}";
                        if (url.indexOf('?') > -1) {
                            url += '&';
                        } else {
                            url += '?';
                        }
                        url += 't='+Math.random();
                        var formData = $('#theForm').serialize();
                        {$pwdJsCode|default=''}
                        // layer_loading('准备进入');
                        // 显示加载状态
                        $(_this).attr('disabled', true);
                        $(_this).addClass('loading');
                        $(_this).text('登录中');
                        $.ajax({
                            async:false,
                            url: url,
                            data: formData,
                            type:'post',
                            dataType:'json',
                            success:function(res){
                                if(1 == res.code){
                                    // layer_loading('准备进入');
                                    top.location.href = res.url;
                                }else{
                                    // 恢复按钮状态
                                    $(_this).attr('disabled', false);
                                    $(_this).removeClass('loading');
                                    $(_this).text('登录');
                                    fleshVerify();
                                    user_name=false;
                                    password=false;
                                    $('#message').text(res.msg).addClass('show');
                                    setTimeout(function() {
                                        $('#message').removeClass('show');
                                    }, 2000);
                                    return false;
                                }
                            },
                            error : function(e) {
                                // 恢复按钮状态
                                $(_this).attr('disabled', false);
                                $(_this).removeClass('loading');
                                $(_this).text('登录');
                                $('#message').text(e.responseText).addClass('show');
                                setTimeout(function() {
                                    $('#message').removeClass('show');
                                }, 2000);
                            }
                        });
                    }else{
                        return false;
                    }
                });

                clear_session();
                function clear_session()
                {
                    $.ajax({
                        url: "__ROOT_DIR__/index.php?m=api&c=Ajax&a=clear_session",
                        type: 'post',
                        dataType: 'JSON',
                        data: {_ajax: 1},
                        success: function(res){
                        }
                    });
                }
            });
        </script>

        {include file="public/footer" /}
